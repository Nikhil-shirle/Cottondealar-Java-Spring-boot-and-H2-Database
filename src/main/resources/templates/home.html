<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments :: head}"></head>

<body>

    <div th:replace="~{fragments :: navbar}"></div>

    <div class="container fade-in">
        <div style="margin-bottom: 2rem;">
            <h1 style="font-weight: 700; margin-bottom: 0.5rem;">Dashboard</h1>
            <p style="color: var(--text-muted);">Welcome back, Admin. Here's what's happening today.</p>
        </div>

        <!-- Market Rate Card -->
        <div class="card"
            style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(30, 41, 59, 0.5) 100%); border-left: 4px solid var(--primary);">
            <div class="stat-card">
                <span class="stat-label">Today's Cotton Market Rate</span>
                <div style="display: flex; align-items: baseline; gap: 1rem;">
                    <span class="stat-val" th:text="${todayRate != null ? todayRate.pricePerKg : 'Not Set'} + ' / kg'">₹
                        -- / kg</span>
                    <span style="color: var(--success); font-weight: 600; font-size: 0.9rem;">Live Update</span>
                </div>
                <div style="margin-top: 1rem;" th:if="${todayRate == null}">
                    <button class="btn-primary" onclick="document.getElementById('rateModal').style.display='block'"
                        style="padding: 0.5rem 1rem; font-size: 0.9rem;">Set Today's Rate</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Filters -->
        <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
            <h3 style="margin-top: 0; font-size: 1rem; color: var(--text-muted); text-transform: uppercase;">Filter
                Purchase Analysis</h3>
            <form th:action="@{/}" method="get"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: end;">
                <div>
                    <label>Price / Kg</label>
                    <input type="number" step="0.01" name="searchPrice" th:value="${searchPrice}" class="form-control"
                        placeholder="Rate">
                </div>
                <div>
                    <label>Customer Name</label>
                    <input type="text" name="searchName" th:value="${searchName}" class="form-control"
                        placeholder="Name">
                </div>
                <div>
                    <label>Address</label>
                    <input type="text" name="searchAddress" th:value="${searchAddress}" class="form-control"
                        placeholder="Location">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn-primary" style="width: 100%;">Filter</button>
                    <a href="/"
                        style="min-width: 80px; text-align: center; border: 1px solid #ddd; padding: 0.5rem; border-radius: 8px; text-decoration: none; color: #555;">Clear</a>
                </div>
            </form>
        </div>

        <!-- Stats Grid -->
        <div class="grid-4" style="margin-bottom: 2rem;">
            <div class="card stat-card">
                <span class="stat-label">Total Purchased (Filtered)</span>
                <span class="stat-val" th:text="${totalPurchasedKg}">0</span>
            </div>
            <div class="card stat-card">
                <span class="stat-label">Total Sold (Global)</span>
                <span class="stat-val" th:text="${totalSoldKg}">0</span>
            </div>
            <div class="card stat-card">
                <span class="stat-label">Stock Available (Global)</span>
                <span class="stat-val"
                    th:style="${stockAvailable < 0 ? 'color: var(--danger)' : 'color: var(--warning)'}"
                    th:text="${stockAvailable}">0</span>
            </div>
            <div class="card stat-card">
                <span class="stat-label">Net Profit (Global)</span>
                <span class="stat-val" th:style="${netProfit >= 0 ? 'color: var(--success)' : 'color: var(--danger)'}"
                    th:text="'₹ ' + ${netProfit}">₹ 0.0</span>
            </div>
        </div>

        <!-- Rate Modal -->
        <div id="rateModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;">
            <div
                style="background: var(--bg-card); width: 100%; max-width: 400px; margin: 15vh auto; padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <h2 style="margin-top: 0;">Set Today's Rate</h2>
                <form th:action="@{/rate}" th:object="${newRate}" method="post">
                    <label>Price per Kg</label>
                    <input type="number" step="0.01" th:field="*{pricePerKg}" class="form-control" required autofocus>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn-primary" style="flex: 1;">Save Rate</button>
                        <button type="button" onclick="document.getElementById('rateModal').style.display='none'"
                            style="flex: 1; background: transparent; border: 1px solid var(--secondary); color: white; padding: 0.75rem; border-radius: 8px; cursor: pointer;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid-2">
            <div class="card">
                <h3 style="margin-top: 0;" th:text="${chartTitle}">Purchase Analysis</h3>
                <canvas id="purchaseChart"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-top: 0;">Sales vs Stock</h3>
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments :: footer}"></div>

    <script th:inline="javascript">
        // Render Purchase Chart (Server Data)
        document.addEventListener('DOMContentLoaded', function () {
            /*[[${pieLabels}]]*/ const labels = [[${ pieLabels }]];
            /*[[${pieData}]]*/ const values = [[${ pieData }]];

            const ctx1 = document.getElementById('purchaseChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: (labels && labels.length > 0) ? labels : ['No Data'],
                    datasets: [{
                        data: (values && values.length > 0) ? values : [1],
                        backgroundColor: (values && values.length > 0) ? ['#0ea5e9', '#6366f1', '#f59e0b', '#22c55e', '#ef4444'] : ['#e2e8f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });
        });

        // Fetch and Render Sales Chart (Existing API)
        fetch('/api/stats/sales-log')
            .then(response => response.json())
            .then(data => {
                const labels = Object.keys(data);
                const values = Object.values(data);

                const ctx2 = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels.length > 0 ? labels : ['No Sales'],
                        datasets: [{
                            label: 'Sales (Kg)',
                            data: values.length > 0 ? values : [0],
                            backgroundColor: '#22c55e',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            });
    </script>

</body>

</html>